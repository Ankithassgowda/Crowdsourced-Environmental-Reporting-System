{% extends "base.html" %}

{% block title %}My Complaints - Environmental Issues{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="fw-bold">
                    <i class="fas fa-list me-2 text-success"></i>My Complaints
                </h1>
                <a href="{{ url_for('complaint') }}" class="btn btn-success">
                    <i class="fas fa-plus me-1"></i>New Complaint
                </a>
            </div>
        </div>
    </div>
    
    {% if complaints %}
        <div class="row g-4">
            {% for complaint in complaints %}
                <div class="col-lg-6">
                    <div class="card user-complaint-card" id="complaint-card-{{ complaint._id }}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">
                                    <i class="fas fa-{{ 
                                        'tree' if complaint.issue_type=='cutting_trees' else 
                                        'trash' if complaint.issue_type=='garbage' else 
                                        'water' 
                                    }} me-2"></i>
                                    {{ complaint.issue_type.replace('_',' ').title() }}
                                </h6>
                                <small class="text-muted">
                                    {{ complaint.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                                </small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-{{ 
                                    'danger' if complaint.status=='Pending' else 
                                    'warning' if complaint.status=='Under-review' else 
                                    'success' if complaint.status=='Resolved' else 
                                    'secondary' 
                                }} mb-2">
                                    {{ complaint.status }}
                                </span>
                                {% if complaint.prediction_result %}
                                    <br>
                                    <span class="badge bg-{{ 'success' if complaint.ai_prediction_match else 'warning' }} small">
                                        <i class="fas fa-robot me-1"></i>
                                        AI: {{ complaint.prediction_result[0].predicted_class.replace('_',' ').title() }}
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-sm-6">
                                    <strong><i class="fas fa-map-marker-alt me-1"></i>Location:</strong>
                                    <p class="mb-1">{{ complaint.location }}</p>
                                </div>
                                <div class="col-sm-6">
                                    <strong><i class="fas fa-clock me-1"></i>Last Updated:</strong>
                                    <p class="mb-1">{{ complaint.updated_at.strftime('%B %d, %Y') }}</p>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <strong><i class="fas fa-align-left me-1"></i>Description:</strong>
                                <p class="mb-2">{{ complaint.description }}</p>
                            </div>
                            
                            <div class="mb-3">
                                <strong><i class="fas fa-images me-1"></i>Images Uploaded:</strong>
                                <div class="image-grid mt-1">
                                    {% for image in complaint.images[:2] %}
                                        <div class="image-wrapper" onclick="openImageModal(this.querySelector('img').src)">
                                            <img src="{{ url_for('static', filename='uploads/' + image) }}"
                                                 alt="Complaint Image">
                                            <div class="overlay">
                                                <i class="fas fa-search-plus"></i>
                                            </div>
                                        </div>
                                    {% endfor %}
                                    {% if complaint.images|length > 2 %}
                                        <div class="image-wrapper more-images-wrapper" onclick="openAllImagesModal('{{ complaint._id }}')">
                                            <div class="more-images-content">
                                                <div class="more-images-text">
                                                    <i class="fas fa-images mb-2"></i>
                                                    <div>+{{ complaint.images|length - 2 }} more</div>
                                                </div>
                                            </div>
                                            <div class="overlay">
                                                <i class="fas fa-expand"></i>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Hidden div with all images for modal -->
                                <div id="allImages{{ complaint._id }}" style="display: none;">
                                    {% for image in complaint.images %}
                                        <img src="{{ url_for('static', filename='uploads/' + image) }}" alt="Complaint Image">
                                    {% endfor %}
                                </div>
                            </div>
                            
                            {% if complaint.admin_notes %}
                                <div class="mb-3">
                                    <strong><i class="fas fa-sticky-note me-1"></i>Admin Notes:</strong>
                                    <div class="alert alert-info">{{ complaint.admin_notes }}</div>
                                </div>
                            {% endif %}
                            
                            <!-- Status Timeline -->
                            <div class="status-timeline">
                                <div class="timeline-item {{ 'active' if complaint.status in ['Pending','Under-review','Resolved'] else '' }}">
                                    <div class="timeline-dot bg-warning"></div>
                                    <div class="timeline-content">Pending</div>
                                </div>
                                <div class="timeline-item {{ 'active' if complaint.status in ['Under-review','Resolved'] else '' }}">
                                    <div class="timeline-dot bg-info"></div>
                                    <div class="timeline-content">Under Review</div>
                                </div>
                                <div class="timeline-item {{ 'active' if complaint.status=='Resolved' else '' }}">
                                    <div class="timeline-dot bg-success"></div>
                                    <div class="timeline-content">Resolved</div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="fas fa-hashtag me-1"></i>ID: {{ complaint._id }}
                                </small>
                                {% if complaint.status == 'Pending' %}
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteComplaint('{{ complaint._id }}')">
                                        <i class="fas fa-trash-alt me-1"></i>Delete
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-5">
            <img src="https://img.icons8.com/color/128/000000/empty-box.png" alt="No Complaints">
            <h3 class="mt-3">No Complaints Yet</h3>
            <p class="text-muted">You haven't submitted any environmental issue reports yet.</p>
            <a href="{{ url_for('complaint') }}" class="btn btn-success">
                <i class="fas fa-plus me-1"></i>Submit Your First Report
            </a>
        </div>
    {% endif %}
</div>

<!-- Single Image Modal -->
<div id="imageModal" class="image-modal-overlay">
    <div class="image-modal-content">
        <span class="close-modal" onclick="closeImageModal()">&times;</span>
        <img id="modalImage" class="modal-image">
    </div>
</div>

<!-- All Images Modal -->
<div id="allImagesModal" class="image-modal-overlay">
    <div class="image-modal-content">
        <span class="close-modal" onclick="closeAllImagesModal()">&times;</span>
        <div id="allImagesContainer" class="all-images-container">
            <!-- Images will be populated by JavaScript -->
        </div>
    </div>
</div>

<style>
.user-complaint-card {
    border-left: 4px solid #28a745;
    transition: all 0.3s ease;
}
.user-complaint-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.status-timeline {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 8px;
}
.timeline-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    opacity: 0.5;
    transition: opacity 0.3s ease;
}
.timeline-item.active { opacity: 1; }
.timeline-dot {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    margin-bottom: 8px;
    border: 3px solid white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.timeline-content {
    font-size: 0.8rem;
    font-weight: 500;
    text-align: center;
}
@media (max-width: 768px) {
    .status-timeline {
        flex-direction: column;
        gap: 15px;
    }
    .timeline-item {
        flex-direction: row;
        justify-content: flex-start;
    }
    .timeline-dot {
        margin-right: 10px;
        margin-bottom: 0;
    }
}

/* Image Grid & Modal Styles */
.image-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 15px;
    margin-top: 10px;
}
.image-wrapper {
    position: relative;
    width: 100%;
    padding-top: 75%;
    overflow: hidden;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.image-wrapper:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.image-wrapper img {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    object-fit: cover;
}
.image-wrapper .overlay {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.4);
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}
.image-wrapper:hover .overlay {
    opacity: 1;
}
.image-wrapper .overlay i {
    color: #fff;
    font-size: 24px;
}

/* More Images Wrapper Styles */
.more-images-wrapper {
    background: linear-gradient(135deg, #28a745, #20c997);
}
.more-images-content {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}
.more-images-text {
    text-align: center;
    font-weight: 600;
}
.more-images-text i {
    font-size: 28px;
    opacity: 0.9;
}
.more-images-text div {
    font-size: 14px;
    margin-top: 5px;
}

.image-modal-overlay {
    display: none;
    position: fixed;
    z-index: 1050;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.9);
    backdrop-filter: blur(5px);
    animation: fadeIn 0.3s forwards;
}
.image-modal-content {
    position: relative;
    margin: auto;
    padding: 20px;
    width: 90%; max-width: 900px;
    height: 90%;
    display: flex; align-items: center; justify-content: center;
    animation: zoomIn 0.3s forwards;
}
.modal-image {
    max-width: 100%; max-height: 100%;
    border-radius: 8px;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    object-fit: contain;
}

/* All Images Container */
.all-images-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    max-height: 80vh;
    overflow-y: auto;
    padding: 20px;
    width: 100%;
}
.all-images-container img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.2s ease;
}
.all-images-container img:hover {
    transform: scale(1.05);
}

.close-modal {
    position: absolute;
    top: 20px; right: 35px;
    color: #fff;
    font-size: 3rem;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.2s ease;
    z-index: 1051;
}
.close-modal:hover {
    color: #ccc;
    transform: rotate(90deg);
}
@keyframes fadeIn {
    from { opacity: 0; } to { opacity: 1; }
}
@keyframes zoomIn {
    from { transform: scale(0.8); } to { transform: scale(1); }
}
@media (max-width: 768px) {
    .image-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
    }
    .close-modal {
        top: 15px; right: 20px; font-size: 2rem;
    }
    .image-modal-content {
        padding: 15px;
        width: 95%; height: 95%;
    }
    .all-images-container {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        padding: 10px;
    }
    .all-images-container img {
        height: 100px;
    }
}
</style>

<script>
// Single image modal functions
function openImageModal(src) {
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    modalImage.src = src;
    modal.style.display = 'flex';
    modal.onclick = (e) => { if (e.target === modal) closeImageModal(); };
}

function closeImageModal() {
    const modal = document.getElementById('imageModal');
    modal.style.display = 'none';
    modal.onclick = null;
}

// All images modal functions
function openAllImagesModal(complaintId) {
    const modal = document.getElementById('allImagesModal');
    const container = document.getElementById('allImagesContainer');
    const allImagesDiv = document.getElementById('allImages' + complaintId);
    
    // Clear previous content
    container.innerHTML = '';
    
    // Copy all images to modal container
    const images = allImagesDiv.querySelectorAll('img');
    images.forEach(img => {
        const newImg = img.cloneNode(true);
        newImg.onclick = () => openImageModal(newImg.src);
        container.appendChild(newImg);
    });
    
    modal.style.display = 'flex';
    modal.onclick = (e) => { if (e.target === modal) closeAllImagesModal(); };
}

function closeAllImagesModal() {
    const modal = document.getElementById('allImagesModal');
    modal.style.display = 'none';
    modal.onclick = null;
}

// Delete complaint function
function deleteComplaint(complaintId) {
    if (confirm('Are you sure you want to permanently delete this complaint? This action cannot be undone.')) {
        fetch(`/delete_complaint/${complaintId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // Add CSRF token if you have one
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                // Remove the complaint card from the UI
                document.getElementById('complaint-card-' + complaintId).remove();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An unexpected error occurred. Please try again.');
        });
    }
}

// Close modals with Escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeImageModal();
        closeAllImagesModal();
    }
});
</script>
{% endblock %}